<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meow Threes! - UI Fix Edition</title>
    <style>
        :root {
            --bg-color: #9db2bf;
            --grid-bg: #dde6ed;
            --board-size: clamp(300px, 92vw, 400px);
            --gap: 12px;
            --color-3: #e2e8f0;
            --color-6: #cbd5e1;
            --color-12: #94a3b8;
            --color-24: #64748b;
            --color-huge: #334155;
        }

        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; }

        body {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; background-color: #f8fafc;
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            touch-action: none; overflow: hidden;
        }

        /* --- Header & Stats --- */
        .header { 
            width: var(--board-size); display: flex; justify-content: space-between; 
            margin-bottom: 15px; align-items: center;
        }
        
        .cat-logo-wrap { display: flex; align-items: center; gap: 8px; }
        .cat-head {
            position: relative; width: 42px; height: 35px;
            background: #7d8e9e; border-radius: 50% 50% 40% 40%;
        }
        .cat-head::before, .cat-head::after {
            content: ''; position: absolute; top: -6px; width: 0; height: 0;
            border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-bottom: 12px solid #7d8e9e;
        }
        .cat-head::before { left: 0; transform: rotate(-15deg); }
        .cat-head::after { right: 0; transform: rotate(15deg); }
        .cat-eyes {
            position: absolute; top: 14px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
        }
        .cat-eyes::before, .cat-eyes::after {
            content: ''; width: 3px; height: 3px; background: white; border-radius: 50%;
        }
        .logo-text { font-size: 22px; font-weight: 900; color: #526d82; font-style: italic; white-space: nowrap; }

        .stats { display: flex; gap: 6px; }
        .box { 
            background: white; border-radius: 10px; padding: 4px 8px;
            box-shadow: 0 4px #cbd5e1; text-align: center; 
            min-width: 65px; height: 55px; /* Âõ∫ÂÆöÈ´òÂ∫¶Á°Æ‰øùÂØπÈΩê */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .label { font-size: 9px; color: #94a3b8; font-weight: bold; text-transform: uppercase; margin-bottom: 1px; }
        .val { font-size: 18px; font-weight: bold; color: #1e293b; line-height: 1; margin: 0; }

        #next-card {
            width: 22px; height: 26px; border-radius: 4px; display: flex; 
            align-items: center; justify-content: center;
            font-weight: bold; font-size: 13px; box-shadow: 0 2px rgba(0,0,0,0.1);
        }

        /* --- Game Board --- */
        #game-container {
            position: relative; width: var(--board-size); height: var(--board-size);
            background: var(--bg-color); border-radius: 16px; padding: var(--gap);
            box-shadow: 0 8px #526d82;
        }
        #bg-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(4, 1fr); grid-gap: var(--gap);
            width: 100%; height: 100%;
        }
        .empty-cell { background: var(--grid-bg); border-radius: 8px; }

        /* --- Tile Styling --- */
        .tile {
            position: absolute; top: 0; left: 0;
            width: calc((var(--board-size) - (var(--gap) * 5)) / 4);
            height: calc((var(--board-size) - (var(--gap) * 5)) / 4);
            border-radius: 8px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-weight: bold; z-index: 10;
            transition: transform 0.1s ease-out;
            box-shadow: 0 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .n-1 { background: #55b4ff; color: white; border-bottom: 5px solid #3d9be6; }
        .n-2 { background: #ff4d6d; color: white; border-bottom: 5px solid #e63555; }
        .n-3 { background: var(--color-3); color: #475569; border-bottom: 5px solid #cbd5e1; }
        .n-6 { background: var(--color-6); color: #334155; border-bottom: 5px solid #94a3b8; }
        .n-12 { background: var(--color-12); color: white; border-bottom: 5px solid #64748b; }
        .n-24 { background: var(--color-24); color: white; border-bottom: 5px solid #475569; }
        .n-huge { background: var(--color-huge); color: white; border-bottom: 5px solid #1e293b; }

        /* Face Details */
        .tile::after { content: '‚Ä¢ ‚Ä¢'; font-size: 10px; margin-top: 2px; opacity: 0.5; letter-spacing: 2px; }
        .n-1::after { content: '¬∞ œâ ¬∞'; }
        .n-2::after { content: '‚óï œâ ‚óï'; }
        .n-3::after { content: '„Éü üëÅÔ∏è üëÅÔ∏è „Éü'; font-size: 8px; }

        /* --- Overlay --- */
        #game-over-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 41, 59, 0.92); border-radius: 16px; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s;
            backdrop-filter: blur(8px); color: white; text-align: center;
        }
        #game-over-overlay.visible { opacity: 1; pointer-events: auto; }
        .btn-retry {
            background: #55b4ff; color: white; border: none; padding: 12px 35px;
            border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer;
            margin-top: 15px; box-shadow: 0 4px #3d9be6;
        }

        .restart-footer { margin-top: 20px; color: #94a3b8; cursor: pointer; font-size: 13px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div class="cat-logo-wrap">
            <div class="cat-head"><div class="cat-eyes"></div></div>
            <div class="logo-text">Meow Threes!</div>
        </div>
        <div class="stats">
            <div class="box">
                <span class="label">NEXT</span>
                <div id="next-card">?</div>
            </div>
            <div class="box">
                <span class="label">BEST</span>
                <p id="best-val" class="val">0</p>
            </div>
            <div class="box">
                <span class="label">SCORE</span>
                <p id="score-val" class="val">0</p>
            </div>
        </div>
    </div>

    
    <div id="game-container">
        <div id="bg-grid">
            <div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div>
            <div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div>
            <div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div>
            <div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div><div class="empty-cell"></div>
        </div>

        <div id="game-over-overlay">
            <h2 style="font-size: 30px; margin: 0 0 10px 0;">Mew-ver!</h2>
            <p style="opacity: 0.8; margin: 0 0 20px 0;">No more room for kittens.</p>
            <div style="background: rgba(255,255,255,0.1); padding: 15px 30px; border-radius: 12px;">
                <p style="margin: 0; font-size: 14px;">FINAL SCORE</p>
                <span id="final-score" style="font-size: 32px; font-weight: bold;">0</span>
                <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.6;">BEST: <span id="final-best">0</span></p>
            </div>
            <button class="btn-retry" onclick="resetGame()">Try Again</button>
        </div>
    </div>

    <div class="restart-footer" onclick="resetGame()">‚Üª RESTART KITTENS</div>

    <script>
        const container = document.getElementById('game-container');
        const nextCard = document.getElementById('next-card');
        const scoreUI = document.getElementById('score-val');
        const bestUI = document.getElementById('best-val');
        const overlay = document.getElementById('game-over-overlay');
        const finalScoreUI = document.getElementById('final-score');
        const finalBestUI = document.getElementById('final-best');

        let board = Array(16).fill(0);
        let score = 0;
        let bestScore = localStorage.getItem('threes_cat_best_v3') || 0;
        let nextValue = 1;
        let tileDeck = [];

        function init() {
            board = Array(16).fill(0);
            score = 0;
            bestUI.innerText = bestScore;
            overlay.classList.remove('visible');
            fillDeck();
            nextValue = drawFromDeck();
            for(let i=0; i<6; i++) spawnInitial();
            updateNextUI();
            render();
        }

        function resetGame() { init(); }

        function fillDeck() {
            tileDeck = [1,1,1,1,2,2,2,2,3,3,3,3];
            tileDeck.sort(() => Math.random() - 0.5);
        }

        function drawFromDeck() {
            if (tileDeck.length === 0) fillDeck();
            return tileDeck.pop();
        }

        function spawnInitial() {
            const empty = board.map((v, i) => v === 0 ? i : null).filter(v => v !== null);
            if (empty.length > 0) {
                const idx = empty[Math.floor(Math.random() * empty.length)];
                board[idx] = Math.floor(Math.random() * 3) + 1;
            }
        }

        function updateNextUI() {
            const colors = { 1: '#55b4ff', 2: '#ff4d6d', 3: 'var(--color-3)' };
            nextCard.style.backgroundColor = colors[nextValue] || 'white';
            nextCard.style.color = nextValue === 3 ? '#475569' : 'white';
            nextCard.innerText = nextValue;
        }

        // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÊ†πÊçÆÊï∞Â≠óÈïøÂ∫¶ËøîÂõûÂ≠óÂè∑ ---
        function getFontSize(val) {
            const len = val.toString().length;
            if (len <= 2) return '28px';
            if (len === 3) return '22px';
            if (len === 4) return '18px';
            return '14px';
        }

        function getTileClass(val) {
            if (val <= 2) return `n-${val}`;
            if (val === 3) return 'n-3';
            if (val === 6) return 'n-6';
            if (val === 12) return 'n-12';
            if (val === 24) return 'n-24';
            return 'n-huge';
        }

        function render() {
            document.querySelectorAll('.tile').forEach(t => t.remove());
            const gap = 12;
            const containerWidth = container.offsetWidth || 400;
            const tileSize = (containerWidth - gap * 5) / 4;

            board.forEach((val, i) => {
                if (val > 0) {
                    const t = document.createElement('div');
                    t.className = `tile ${getTileClass(val)}`;
                    t.innerText = val;
                    
                    // ËÆæÁΩÆÂä®ÊÄÅÂ≠óÂè∑
                    t.style.fontSize = getFontSize(val);
                    
                    const row = Math.floor(i / 4), col = i % 4;
                    const x = col * (tileSize + gap) + gap;
                    const y = row * (tileSize + gap) + gap;
                    
                    t.style.width = `${tileSize}px`;
                    t.style.height = `${tileSize}px`;
                    t.style.transform = `translate(${x}px, ${y}px)`;
                    container.appendChild(t);
                }
            });

            scoreUI.innerText = score;
            if (score > bestScore) {
                bestScore = score;
                bestUI.innerText = bestScore;
                localStorage.setItem('threes_cat_best_v3', bestScore);
            }
        }

        function canMerge(a, b) {
            if (a === 0 || b === 0) return false;
            if ((a === 1 && b === 2) || (a === 2 && b === 1)) return true;
            return (a >= 3 && a === b);
        }

        function checkGameOver() {
            if (board.includes(0)) return false;
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    let curr = board[r * 4 + c];
                    if (c < 3 && canMerge(curr, board[r * 4 + c + 1])) return false;
                    if (r < 3 && canMerge(curr, board[(r + 1) * 4 + c])) return false;
                }
            }
            return true;
        }

        function move(dir) {
            if (overlay.classList.contains('visible')) return;
            let moved = false;
            let moveInfo = [];
            const isH = dir === 'LEFT' || dir === 'RIGHT';
            const isRev = dir === 'RIGHT' || dir === 'DOWN';

            for (let i = 0; i < 4; i++) {
                let indices = [];
                for (let j = 0; j < 4; j++) indices.push(isH ? (i*4+j) : (j*4+i));
                if (isRev) indices.reverse();

                let lineMoved = false;
                for (let k = 0; k < 3; k++) {
                    let curr = indices[k], next = indices[k+1];
                    if (board[curr] === 0 && board[next] !== 0) {
                        board[curr] = board[next]; board[next] = 0; lineMoved = true;
                    } else if (canMerge(board[curr], board[next])) {
                        board[curr] += board[next]; score += board[curr]; board[next] = 0;
                        lineMoved = true;
                        for(let m=k+1; m<3; m++) { board[indices[m]] = board[indices[m+1]]; board[indices[m+1]] = 0; }
                        break;
                    }
                }
                if (lineMoved) { moved = true; moveInfo.push(i); }
            }

            if (moved) {
                const randomLine = moveInfo[Math.floor(Math.random() * moveInfo.length)];
                let spawnIdx;
                if (dir === 'LEFT') spawnIdx = randomLine * 4 + 3;
                else if (dir === 'RIGHT') spawnIdx = randomLine * 4;
                else if (dir === 'UP') spawnIdx = 12 + randomLine;
                else if (dir === 'DOWN') spawnIdx = randomLine;

                board[spawnIdx] = nextValue;
                nextValue = drawFromDeck();
                updateNextUI();
                render();
                if (checkGameOver()) {
                    finalScoreUI.innerText = score;
                    finalBestUI.innerText = bestScore;
                    setTimeout(() => overlay.classList.add('visible'), 500);
                }
            }
        }

        let startX, startY, isDown = false;
        const handleStart = (x, y) => { startX = x; startY = y; isDown = true; };
        const handleEnd = (x, y) => {
            if (!isDown) return; isDown = false;
            const dx = x - startX, dy = y - startY;
            if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                if (Math.abs(dx) > Math.abs(dy)) move(dx > 0 ? 'RIGHT' : 'LEFT');
                else move(dy > 0 ? 'DOWN' : 'UP');
            }
        };

        container.addEventListener('touchstart', e => handleStart(e.touches[0].clientX, e.touches[0].clientY));
        container.addEventListener('touchend', e => handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY));
        container.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
        window.addEventListener('mouseup', e => handleEnd(e.clientX, e.clientY));
        window.addEventListener('keydown', e => {
            if (e.key.includes('Arrow')) { e.preventDefault(); move(e.key.replace('Arrow','').toUpperCase()); }
        });

        window.onload = () => setTimeout(init, 100);
    </script>
</body>
</html>